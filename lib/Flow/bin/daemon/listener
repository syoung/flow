#!/usr/bin/perl -w

=head2

PURPOSE

    1. Listen for RabbitMQ 'task' queue messages sent from Queuer
     
   2. Save status update to the 'queuesample' table
   
        Overall status of the sample: none, queued, running, completed 
 
INPUT

    1. FOR MANUAL TESTING, PROVIDE A SUBCOMMAND, E.G.:

        SYSTEM

        /a/bin/daemon/listener --log 4 --json '{"sourceid":"","version":"0.0.1","stdout":"","queued":"2016-03-09 13:11:01","token":null,"callback":"","host":"ip-10-50-1-187","username":"admin","time":"2016-03-09 13:11:01","samplehash":{"outputdir":"/data/bam","sourcebucket":"itmi.cl.macrogen","targetbucket":"itmi.cl.macrogenqc","sample":"16032a86-ecba-4377-ae0b-e51aa2623b61","run":"1509UNHX-0002","status":"","project":"QC","ordinal":"76","username":"admin","subject":"GM14057"},"sendtype":"report","project":"QC","installdir":"/usr/bin","sample":"16032a86-ecba-4377-ae0b-e51aa2623b61","processid":31095,"location":"aws","mode":"updateJobStatus","stage":"downloadVCF","completed":"0000-00-00 00:00:00","started":"2016-03-09 13:11:01","workflow":"All","number":"1","ipaddress":"10.50.1.187","workflownumber":"1","name":"downloadVCF","database":"agua","status":"started","queue":"update.job.status","stagenumber":"1","stderr":""}'

        /a/bin/daemon/listener --log 4 --json '{"mode":"updateJobStatus","location":"aws","stage":"uploadHetHom","started":"2016-03-10 08:11:37","workflow":"All","completed":"2016-03-09 22:18:38","ipaddress":"10.50.1.187","number":"15","name":"uploadHetHom","workflownumber":"1","status":"completed","queue":"update.job.status","stderr":"","stagenumber":"15","queued":"2016-03-10 08:11:37","stdout":"upload: data/bam/200ce43f-15af-4a76-9d91-8157773a642d/200ce43f-15af-4a76-9d91-8157773a642d.hethom to s3://itmi.cl.macrogenqc/1509UNHX-0001/200ce43f-15af-4a76-9d91-8157773a642d/200ce43f-15af-4a76-9d91-8157773a642d.hethom","version":"0.0.1","time":"2016-03-10 08:11:39","username":"admin","host":"ip-10-50-1-187","installdir":"/usr/bin","project":"QC","samplehash":{"sourcebucket":"itmi.cl.macrogen","outputdir":"/data/bam","subject":"GM12880","username":"admin","ordinal":"22","status":"","project":"QC","sample":"200ce43f-15af-4a76-9d91-8157773a642d","run":"1509UNHX-0001","targetbucket":"itmi.cl.macrogenqc"},"sample":"200ce43f-15af-4a76-9d91-8157773a642d"}'

        /a/bin/daemon/listener --log 4 --json '{"callback":"","host":"Ip-10-50-1-187","username":"admin","mode":"updateJobStatus","sourceid":"","stage":"checkBamPresent","location":"bin/logic/fork","ipaddress":"10.50.1.187","version":"0.0.1","samplehash":{"outputdir":"/data/bam","run":"1509UNHX-0001","status":"","subject":"GM12217","project":"QC","ordinal":"68","username":"admin","sourcebucket":"itmi.cl.macrogen","targetbucket":"itmi.cl.macrogenqc","sample":"5482e527-a48a-4e12-b765-64a017eeb3ce"},"completed":"0000-00-00 00:00:00","started":"2016-03-20 16:43:23","stderr":"","stdout":"","token":null,"processid":4257,"queued":"2016-03-20 16:43:23","workflownumber":"1","sample":"5482e527-a48a-4e12-b765-64a017eeb3ce","installdir":"/a","sendtype":"report","database":"agua","name":"checkBamPresent","time":"2016-03-20 16:43:23","project":"QC","status":"started","workflow":"All","stagenumber":"5","number":"5","queue":"update.job.status"}'

        /a/bin/daemon/listener --log 4 --json '{"time":"2016-03-21 04:01:27","username":"admin","stage":"downloadBam","sample":"9a9855f8-16db-4f0e-a875-5133bc19616b","stdout":"","stderr":"","workflownumber":"1","version":"0.0.1","host":"Ip-10-50-1-149","processid":18773,"token":undef,"queued":"2016-03-21 04:01:27","project":"QC","workflow":"All","name":"downloadBam","sourceid":"","installdir":"/usr/bin","queue":"update.job.status","started":"2016-03-21 04:01:27","number":"6","ipaddress":"10.50.1.149","status":"started","mode":"updateJobStatus","samplehash":{"run":"1509UNHX-0002","subject":"GM01763","project":"QC","sourcebucket":"itmi.cl.macrogen","status":"","outputdir":"/data/bam","sample":"9a9855f8-16db-4f0e-a875-5133bc19616b","ordinal":"52","username":"admin","targetbucket":"itmi.cl.macrogenqc"},"stagenumber":"6","database":"agua","callback":"","sendtype":"report","completed":"2016-03-20 18:58:04","location":"aws"}'


        /a/bin/daemon/listener --log 4 --json '{"queued":"2016-03-21 04:01:13","project":"QC","workflownumber":"1","processid":18773,"token":undef,"host":"Ip-10-50-1-149","version":"0.0.1","time":"2016-03-21 04:01:24","stage":"downloaddownload: s3://itmi.cl.macrogen/1509UNHX-0002/9a9855f8-16db-4f0e-a875-5133bc19616b/9a9855f8-16db-4f0e-a875-5133bc19616b_SNP_INDEL.vcf to data/bam/9a9855f8-16db-4f0e-a875-5133bc19616b/9a9855f8-16db-4f0e-a875-5133bc19616b_SNP_INDEL.vcf","sample":"9a9855f8-16db-4f0e-a875-5133bc19616b","stderr":"","username":"admin","completed":"2016-03-20 18:10:20","callback":"","sendtype":"report","database":"agua","samplehash":{"run":"1509UNHX-0002","subject":"GM01763","status":"","sourcebucket":"itmi.cl.macrogen","project":"QC","outputdir":"/data/bam","ordinal":"52","username":"admin","sample":"9a9855f8-16db-4f0e-a875-5133bc19616b","targetbucket":"itmi.cl.macrogenqc"},"stagenumber":"2","location":"aws","started":"2016-03-21 04:01:13","number":"2","mode":"updateJobStatus","ipaddress":"10.50.1.149","status":"completed","sourceid":"","installdir":"/usr/bin","name":"downloadVcf","queue":"update.job.status","workflow":"All"}'


        /a/bin/daemon/listener --log 4 --json '{"time":"2016-03-09 17:50:34","stage":"downloadVCF","number":"1","queue":"update.job.status","sample":"29246fb6-f34c-4112-a89f-c13837079291","version":"0.0.1","location":"aws","project":"QC","queued":"2016-03-09 17:50:22","started":"2016-03-09 17:50:22","stderr":"","samplehash":{"username":"admin","run":"1508UNHX-0001","sample":"29246fb6-f34c-4112-a89f-c13837079291","subject":"103-00036-03","targetbucket":"itmi.cl.macrogenqc","project":"QC","sourcebucket":"itmi.cl.macrogen","ordinal":"40","status":"","outputdir":"/data/bam"},"status":"started","token":null,"database":"agua","workflownumber":"1","stdout":"","username":"admin","callback":"","host":"ip-10-50-1-214","sendtype":"report","mode":"updateJobStatus","processid":685,"completed":"0000-00-00 00:00:00","name":"downloadVCF","ipaddress":"10.50.1.214","sourceid":"","workflow":"All","installdir":"/usr/bin","stagenumber":"1"}'


        /a/bin/daemon/listener --log 4 --json '{"samplehash":{"sample":"c0e1f9a1-afcd-4fc9-8e8f-a0ef48f0f8e3","username":"admin","ordinal":"83","subject":"GM17475","outputdir":"/data/bam","targetbucket":"itmi.cl.macrogenqc","sourcebucket":"itmi.cl.macrogen","status":"","run":"1508UNHX-0016","project":"QC"},"sourceid":"","project":"QC","stderr":"","workflownumber":"1","time":"2016-03-21 18:09:49","ipaddress":"10.50.1.55","callback":"","name":"cleanUp","sample":"c0e1f9a1-afcd-4fc9-8e8f-a0ef48f0f8e3","host":"Ip-10-50-1-55","workflow":"All","completed":"2016-03-21 08:07:32","token":null,"stage":"cleanUp","status":"completed","stdout":"","queued":"2016-03-21 18:09:46","queue":"update.job.status","processid":22928,"number":"25","installdir":"/bin","mode":"updateJobStatus","username":"admin","location":"rm","stagenumber":"25","version":"0.0.1","started":"2016-03-21 18:09:46","database":"agua","sendtype":"report"}'



        CURRENT MESSAGES

        /a/bin/daemon/listener --log 4 --json '{"callback":"","status":"started","time":"2016-03-21 20:34:42","queued":"2016-03-21 20:34:42","installdir":"/a","workflow":"All","stdout":"","mode":"updateJobStatus","sample":"f6fe79aa-35d4-4f47-ade0-f2ce5f7fd9bf","stagenumber":"17","stage":"forkhethom","stderr":"","sendtype":"report","location":"bin/logic/fork","completed":"2016-03-21 15:28:54","name":"forkhethom","processid":19779,"version":"0.0.1","sourceid":"","token":null,"samplehash":{"outputdir":"/data/bam","status":"","sample":"f6fe79aa-35d4-4f47-ade0-f2ce5f7fd9bf","run":"1509UNHX-0001","username":"admin","targetbucket":"itmi.cl.macrogenqc","subject":"GM12879","ordinal":"17","sourcebucket":"itmi.cl.macrogen","project":"QC"},"ipaddress":"10.50.1.248","started":"2016-03-21 20:34:42","host":"Ip-10-50-1-248","number":"17","project":"QC","workflownumber":"1","database":"agua","username":"admin","queue":"update.job.status"}'



OUTPUT

    1. STDOUT OF EXECUTED COMMANDS ALONG WITH RESPECTIVE COMMANDS

    2. SEND DATA TO feedback QUEUE MONITORED BY Siphon::Feedback ON

        MASTER SERVER

=cut

#### EXTERNAL MODULES
use Getopt::Long;
use FindBin qw($Bin);

$|++;

#### INTERNAL MODULES
use Siphon::Listener;

#### GET ARGUMENTS
my @arguments = @ARGV;

#### OBJECT
my $object      =  Siphon::Listener->new({});

#### RUN
$object->run(\@arguments);

##############################################################
